import threading
import subprocess
from Script import Startup, Update
import Script.API
import argparse


def main(args):
    Startup.start_services()
    Update.Update()

    thread = threading.Thread(target=lambda: Script.API.app.run(port=50000, use_reloader=False))
    thread.daemon = True
    thread.start()

    base_cmd = 'curl -H "Content-Type: application/json" '

    try:
        subprocess.run(f'{base_cmd} 127.0.0.1:50000/api/cleanup -X POST', shell=True)
        subprocess.run(f'{base_cmd} 127.0.0.1:50000/api/run -X POST -d \'{{"target": "{args.target}", "username": "{args.username}", "password": "{args.password}"}}\'', shell=True)
        subprocess.run(f'{base_cmd} 127:0.0.1:50000/api/report -X POST -d \'{{"type": "csv"}}\'', shell=True)
        subprocess.run(f'{base_cmd} 127.0.0.1:50000/api/report -X POST -d \'{{"type": "html"}}\'', shell=True)
    except KeyboardInterrupt:
        print('Keyboard interrupt')
        exit(0)

    print('Scan complete')
    exit(0)


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Automated Vulnerability Scanner')
    parser.add_argument('--target', type=str, required=True, help='Scan target')
    parser.add_argument('--username', type=str, required=True, help='OpenVAS username')
    parser.add_argument('--password', type=str, required=True, help='OpenVAS password')
    args = parser.parse_args()
    main(args)
