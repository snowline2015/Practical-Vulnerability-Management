import threading
import requests
from Script import Startup, Update
import Script.API
import argparse


def main(args):
    Startup.start_services()
    Update.Update()

    threading.Thread(target=lambda: Script.API.app.run(port=50000, use_reloader=False)).start()

    base_url = 'http://localhost:50000/api'
    headers = {'Content-Type': 'application/json'}

    requests.post(f'{base_url}/cleanup', headers=headers)
    requests.post(f'{base_url}/run', headers=headers, json={'target': args.target, 'username': args.username, 'password': args.password})
    requests.post(f'{base_url}/report', headers=headers, json={'type': 'csv'})
    requests.post(f'{base_url}/report', headers=headers, json={'type': 'html'})


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Automated Vulnerability Scanner')
    parser.add_argument('--target', type=str, required=True, help='Scan target')
    parser.add_argument('--username', type=str, required=True, help='OpenVAS username')
    parser.add_argument('--password', type=str, required=True, help='OpenVAS password')
    args = parser.parse_args()
    main(args)
