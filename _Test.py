import datetime
import pymongo
import json
from xml.etree import ElementTree as ET

import requests

myclient = pymongo.MongoClient("mongodb://localhost:27017/")
db = myclient["yorha"]

# mydict = { "project": "YoRHa", "name": "2B" }
# x = db.army.insert_one(mydict)
# x = db.army.insert_one(mydict)

# db.army.update_one({'project': 'YoRHa', 'name': 'WTF'},
#                     {'$set': {'project': 'YoRHa', 'type': 'Android'},
#                     }, upsert=True)

# db.army.update_one({'project': 'YoRHa', 'name': '9S'},
#                    {'$push': {'weapon': {'name': 'Machine Gun', 'type': 'Machine Gun'}},
#                     '$setOnInsert': {'project': 'YoRHa', 'name': '9S', 'weapon': [{'name': 'Machine Gun', 'type': 'Machine Gun'}]}},
#                      upsert=True)

# db.hosts.update_one({'project': 'YoRHa', 'name': '2B', 'weapon.$},

# db.army.drop()

# for x in db.army.find():
#     print(x)

# ok = db.army.distinct('project')
# haha = 0

# xml_string = open('Result/gvm.xml').read()
# root = ET.fromstring(xml_string)
#
# res = {}
# oidList = {}
# for reports in root.findall('report'):
#     for report in reports.findall('report'):
#         for results in report.findall('results'):
#             for result in results.findall('result'):
#
#                 # Ignore nested results
#                 if result.find("host") is None:
#                     continue
#
#                 if result.find('name').text not in res:
#                     res[result.find('name').text] = []
#
#                 ipaddress = result.find("host").text
#                 description = result.find('description').text
#                 port, proto = result.find("port").text.split('/')
#
#                 # Parse the NVT (Network Vulnerability Tests) data
#                 nvtblock = result.find("nvt")
#
#                 oid = nvtblock.get("oid")
#                 nvt_name = nvtblock.find("name").text
#                 nvt_family = nvtblock.find("family").text
#
#                 # Ignore vulns whose cvss is 0
#                 cvss = float(nvtblock.find("cvss_base").text)
#                 if cvss == 0:
#                     continue
#                 nvt_bid = nvtblock.find("bid").text.split(", ") if nvtblock.find("bid") is not None else []
#                 nvt_xref = nvtblock.find("xref").text.split(", ") if nvtblock.find("xref") is not None else []
#
#                 cve = []
#                 try:
#                     refs = nvtblock.find("refs").findall("ref")
#                     for ref in refs:
#                         if ref.get('type') == "cve":
#                             cve.append(ref.get('id'))
#                 except:
#                     pass
#
#                 tags_data = {}
#                 tags = nvtblock.find("tags").text.split("|")
#                 for item in tags:
#                     tag_name, tag_value = item.split("=", 1)
#                     tags_data[tag_name] = tag_value
#                 threat = result.find("threat").text
#                 updated = datetime.datetime.utcnow()
#
#                 if ipaddress not in oidList.keys():
#                     oidList[ipaddress] = []
#                 oidList[ipaddress].append({'proto': proto, 'port': port, 'oid': oid})
#
#                 res[result.find('name').text].append({
#                     'ipaddress': ipaddress,
#                     'port': port,
#                     'proto': proto,
#                     'description': description,
#                     'oid': oid,
#                     'nvt_name': nvt_name,
#                     'nvt_family': nvt_family,
#                     'cvss': cvss,
#                     'nvt_bid': nvt_bid,
#                     'nvt_xref': nvt_xref,
#                     'cve': cve,
#                     'tags_data': tags_data,
#                     'threat': threat,
#                     'updated': updated
#                 })
# #
# for vuln in res:
#     for item in res[vuln]:
#         ok = 0

# cve = 'CVE-2003-0605'
# cve_searchsploit = json.load(open('Database/exploitdb_mapping_cve.json'))
# temp = '\n'.join([f'https://www.exploit-db.com/exploits/{exploit}' for exploit in cve_searchsploit[cve]] if cve in cve_searchsploit else [])
# print(temp)


# from Script import Nmap
# Nmap.Nmap.mongo_insert(None, Nmap.Nmap.get_host_data(None, 'Result/nmap.xml'))
# ok = 0

# from Script import GVM
# GVM.OpenVAS.mongo_insert(None, GVM.OpenVAS.parse_xml(None, open('Result/gvm.xml').read()))

xml = """<get_tasks_response status="200" status_text="OK"><apply_overrides>0</apply_overrides><task id="b446494d-1c98-4256-bc1f-c467a0cc9d87"><owner><name>yorha</name></owner><name>192.168.183.0/24</name><comment></comment><creation_time>2023-01-01T19:27:55Z</creation_time><modification_time>2023-01-01T19:27:55Z</modification_time><writable>1</writable><in_use>0</in_use><permissions><permission><name>Everything</name></permission></permissions><alterable>0</alterable><usage_type>scan</usage_type><config id="daba56c8-73ec-11df-a475-002264764cea"><name>Full and fast</name><trash>0</trash></config><target id="c2b2112f-a8a0-4ea9-ba66-b203ef8c8aae"><name>192.168.183.0/24</name><trash>0</trash></target><hosts_ordering></hosts_ordering><scanner id='08b69003-5fc2-4037-a479-93b440211c73'><name>OpenVAS Default</name><type>2</type><trash>0</trash></scanner><status>Done</status><progress>-1</progress><report_count>1<finished>1</finished></report_count><trend></trend><schedule id=""><name></name><trash>0</trash></schedule><schedule_periods>0</schedule_periods><last_report><report id="b5a1274a-2d3c-4f8f-a91c-503cf47fe14c"><timestamp>2023-01-01T19:27:55Z</timestamp><scan_start>2023-01-01T19:28:18Z</scan_start><scan_end>2023-01-01T19:34:26Z</scan_end><result_count><hole>0</hole><info>0</info><log>14</log><warning>1</warning><false_positive>0</false_positive></result_count><severity>5.0</severity></report></last_report><observers></observers><preferences><preference><name>Maximum concurrently executed NVTs per host</name><scanner_name>max_checks</scanner_name><value>4</value></preference><preference><name>Maximum concurrently scanned hosts</name><scanner_name>max_hosts</scanner_name><value>20</value></preference><preference><name>Add results to Asset Management</name><scanner_name>in_assets</scanner_name><value>yes</value></preference><preference><name>Apply Overrides when adding Assets</name><scanner_name>assets_apply_overrides</scanner_name><value>yes</value></preference><preference><name>Min QOD when adding Assets</name><scanner_name>assets_min_qod</scanner_name><value>70</value></preference><preference><name>Auto Delete Reports</name><scanner_name>auto_delete</scanner_name><value>0</value></preference><preference><name>Auto Delete Reports Data</name><scanner_name>auto_delete_data</scanner_name><value>0</value></preference></preferences></task><task id="0270a229-340c-4c35-b5fe-18a6d52cb166"><owner><name>yorha</name></owner><name>192.168.183.0/24</name><comment></comment><creation_time>2023-01-02T04:23:45Z</creation_time><modification_time>2023-01-02T04:23:45Z</modification_time><writable>1</writable><in_use>0</in_use><permissions><permission><name>Everything</name></permission></permissions><alterable>0</alterable><usage_type>scan</usage_type><config id="daba56c8-73ec-11df-a475-002264764cea"><name>Full and fast</name><trash>0</trash></config><target id="c2b2112f-a8a0-4ea9-ba66-b203ef8c8aae"><name>192.168.183.0/24</name><trash>0</trash></target><hosts_ordering></hosts_ordering><scanner id='08b69003-5fc2-4037-a479-93b440211c73'><name>OpenVAS Default</name><type>2</type><trash>0</trash></scanner><status>New</status><progress>-1</progress><report_count>0<finished>0</finished></report_count><trend></trend><schedule id=""><name></name><trash>0</trash></schedule><schedule_periods>0</schedule_periods><observers></observers><preferences><preference><name>Maximum concurrently executed NVTs per host</name><scanner_name>max_checks</scanner_name><value>4</value></preference><preference><name>Maximum concurrently scanned hosts</name><scanner_name>max_hosts</scanner_name><value>20</value></preference><preference><name>Add results to Asset Management</name><scanner_name>in_assets</scanner_name><value>yes</value></preference><preference><name>Apply Overrides when adding Assets</name><scanner_name>assets_apply_overrides</scanner_name><value>yes</value></preference><preference><name>Min QOD when adding Assets</name><scanner_name>assets_min_qod</scanner_name><value>70</value></preference><preference><name>Auto Delete Reports</name><scanner_name>auto_delete</scanner_name><value>0</value></preference><preference><name>Auto Delete Reports Data</name><scanner_name>auto_delete_data</scanner_name><value>0</value></preference></preferences></task><filters id=""><term>apply_overrides=0 min_qod=70 name= 192.168.183.0/24 first=1 rows=10 sort=name</term><keywords><keyword><column>apply_overrides</column><relation>=</relation><value>0</value></keyword><keyword><column>min_qod</column><relation>=</relation><value>70</value></keyword><keyword><column>name</column><relation>=</relation><value></value></keyword><keyword><column></column><relation>~</relation><value>192.168.183.0/24</value></keyword><keyword><column>first</column><relation>=</relation><value>1</value></keyword><keyword><column>rows</column><relation>=</relation><value>10</value></keyword><keyword><column>sort</column><relation>=</relation><value>name</value></keyword></keywords></filters><sort><field>name<order>ascending</order></field></sort><tasks start="1" max="10"/><task_count>2<filtered>2</filtered><page>2</page></task_count></get_tasks_response>"""
import xml.etree.ElementTree as ET
root = ET.fromstring(xml)
target_id = root.findall('task')[0].attrib['id']
ok = 0
