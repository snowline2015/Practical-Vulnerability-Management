import os
from pymongo import MongoClient
import datetime
import csv
import json
import subprocess
from Script.Metasploit import Metasploit

client = MongoClient('mongodb://localhost:27017')
db = client['vulnmgt']
cve_search = client['cvedb']

cve_searchsploit = json.load(open('Database/exploitdb_mapping_cve.json'))

data = [['IP Address', 'Hostname', 'Port', 'Protocol', 'OS', 'Service', 'Product',
         'Vulnerability', 'Category', 'Severity', 'CVE', 'CVE Summary', 'CVE CVSS',
         'CVE Impact Availability', 'CVE Impact Confidentiality', 'CVE Impact Integrity',
         'CVE Access Vector', 'CVE Access Complexity', 'CVE Authentication', 'ExploitDB', 'CVSS',
         'Description', 'NVT BID', 'NVT XREF', 'Tags', 'Metasploit', 'Scan Date']]


def get_data():
    for host in db.hosts.distinct('ip'):
        details = db.hosts.find({'ip': host})
        for detail in details:
            host_data = [detail['ip'], detail.get('hostname', ''), detail['port'], detail['protocol'],
                         detail.get('os', ''), detail.get('service', ''), detail.get('product', '')]

            if 'vuln' not in detail:
                data.append(host_data + [''] * 19 + [detail['scan_date']])
                continue

            for vuln in detail['vuln']:
                cve_data = []
                for cve in vuln['cve']:
                    cve_details = cve_search.cves.find_one({'id': cve})
                    if cve_details:
                        if "impact" not in cve_details:
                            cve_details["impact"] = {"availability": None, "confidentiality": None,
                                                     "integrity": None}
                        if "access" not in cve_details:
                            cve_details["access"] = {"authentication": None, "complexity": None, "vector": None}
                        if "cvss" not in cve_details:
                            cve_details["cvss"] = None

                        cve_data.append([cve_details['id'], cve_details['summary'], cve_details['cvss'],
                                         cve_details['impact']['availability'], cve_details['impact']['confidentiality'],
                                         cve_details['impact']['integrity'], cve_details['access']['authentication'],
                                         cve_details['access']['complexity'], cve_details['access']['vector'],
                                         '\n'.join([f'https://www.exploit-db.com/exploits/{exploit}'
                                                    for exploit in cve_searchsploit[cve]] if cve in cve_searchsploit else [])])
                    else:
                        cve_data.append([cve] + [''] * 8 + ['\n'.join([f'https://www.exploit-db.com/exploits/{exploit}'
                                                    for exploit in cve_searchsploit[cve]] if cve in cve_searchsploit else [])])

                if cve_data:
                    for cve in cve_data:
                        exploit = Metasploit(cve[0])
                        vuln_detail = [vuln['nvt_name'], vuln['nvt_family'], vuln['threat']] + cve + \
                                      [vuln['cvss'], vuln['description'], vuln['nvt_bid'], vuln['nvt_xref'],
                                       '\n'.join([f'{k} | {v}' for k, v in vuln['tags_data'].items()]), exploit,
                                       detail['scan_date']]
                        data.append(host_data + vuln_detail)
                else:
                    vuln_detail = [vuln['nvt_name'], vuln['nvt_family'], vuln['threat']] + [''] * 10 + \
                                    [vuln['cvss'], vuln['description'], vuln['nvt_bid'], vuln['nvt_xref'],
                                     '\n'.join([f'{k} | {v}' for k, v in vuln['tags_data'].items()]), '',
                                     detail['scan_date']]
                    data.append(host_data + vuln_detail)
    return data


def report_csv(path: str = 'Report'):
    if not os.path.exists(path):
        os.makedirs(path)
    timestamp = round(int(datetime.datetime.now().timestamp()))
    with open(f'{path}/report_{timestamp}.csv', 'w', newline='') as file:
        writer = csv.writer(file)
        writer.writerows(get_data())
    print(f'CSV report saved to {path}/report_{timestamp}.csv')


def report_html(path: str = 'Report'):
    if not os.path.exists(path):
        os.makedirs(path)
    timestamp = round(int(datetime.datetime.now().timestamp()))
    report_data = get_data()
    with open(f'{path}/report_{timestamp}.html', 'w') as f:
        f.write(f'<html><head><h1>Scan Report {timestamp}</h1></head><body>')
        for row in report_data[1:]:
            f.write(f'<h2>{row[0]}</h2>')
            for col in report_data[0][1:]:
                if col == 'Tags' and row[report_data[0].index(col)]:
                    tags = '<br>'.join(row[report_data[0].index(col)].split('\n')).replace(' | ', ': ')
                    f.write(f'<p><b>{col}</b>:<br> {tags} </p>')
                else:
                    f.write(f'<p><b>{col}</b>: {row[report_data[0].index(col)]}</p>')
            f.write('<hr>')
        f.write('</body></html>')
    print(f'HTML report saved to {path}/report_{timestamp}.html')
