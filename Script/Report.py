from pymongo import MongoClient
import datetime


client = MongoClient('mongodb://localhost:27017')
db = client['vulnmgt']

data = [['IP Address', 'Hostname', 'Port', 'Protocol', 'OS', 'Service', 'Product',
         'Vulnerability', 'Category', 'Severity', 'CVE', 'CVSS', 'Description', 'NVT BID', 'NVT XREF', 'Tags', 'Scan Date']]


def generate_report():
    # Get the current date and time
    now = datetime.datetime.now()
    date = now.strftime('%Y-%m-%d')
    time = now.strftime('%H:%M:%S')

    # Create the report file
    report_file = f'Report/report_{date}_{time}.csv'
    with open(f'../{report_file}', 'w') as f:
        for host in db.hosts.distinct('ip_address'):
            details = db.hosts.find({'ip_address': host})
            for detail in details:
                host_data = [detail['ip_address'], detail['host_name'], detail['port'], detail['protocol'],
                             detail['os'], detail['service'], detail['product']]

                for vuln in detail['vuln']:
                    vuln_detail = [vuln['nvt_name'], vuln['nvt_family'], vuln['threat'], vuln['cve'], vuln['cvss'],
                                   vuln['description'], vuln['nvt_bid'], vuln['nvt_xref'],
                                   '\n'.join([f'{k} | {v}' for k, v in vuln['tags_data'].items()]), detail['scan_date']]
                    host_data.extend(vuln_detail)
                    data.append(host_data)

        for row in data:
            f.write(','.join(row))
            f.write('\n')

    print(f'Report generated: {report_file}')







